<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>股票分析助手</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@500;700&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=20260211_1" />
</head>
<body>
  <button id="language-toggle-btn" class="lang-toggle" type="button">EN</button>
  <div id="status" aria-live="polite"></div>
  <main class="container" id="capture-target">
    <header class="hero">
      <h1 id="hero-title" data-i18n="hero_title">股票分析助手</h1>
      <p id="hero-hint" class="hint" data-i18n="hero_hint">数据源：第1部分 Finnhub 优先（无 API Key 或数据缺失时回退 yfinance），第2/3部分 yfinance（最新财务、预测）；其后补充模块 yfinance（beat/miss 与 EPS Trend）；第4部分 Yahoo Finance 接口/页面解析（估值字段为主）。金额字段按各股票对应币种展示，带“十亿”字样的字段单位为十亿。</p>
      <div class="hero-tags">
        <span id="hero-tag-1" data-i18n="hero_tag_1">Realtime Market</span>
        <span id="hero-tag-2" data-i18n="hero_tag_2">Financial Cache</span>
        <span id="hero-tag-3" data-i18n="hero_tag_3">AI Research Notes</span>
      </div>
    </header>

    <section class="toolbar">
      <div class="symbol-row">
        <label id="new-symbol-label" for="new-symbol" data-i18n="add_symbol_label">添加股票代码</label>
        <input id="new-symbol" data-i18n-placeholder="add_symbol_placeholder" placeholder="例如 NVDA、0700.HK、600519.SS" />
        <button id="add-symbol-btn" type="button" data-i18n="add_symbol_btn">添加股票</button>
      </div>

      <div class="chips-wrap">
        <div id="symbol-chips" class="chips"></div>
      </div>

      <details id="watchlist-panel" class="watchlist-panel">
        <summary>
          <span class="watchlist-summary-title" data-i18n="watchlist_title">自选股组合</span>
          <span id="watchlist-meta" class="watchlist-meta" data-i18n="watchlist_empty">暂无已保存自选组</span>
        </summary>
        <div class="watchlist-panel-body">
          <div class="watchlist-row">
            <input id="watchlist-name" data-i18n-placeholder="watchlist_name_placeholder" placeholder="输入自选组名称（可选）" />
            <button id="save-watchlist-btn" type="button" data-i18n="watchlist_save_btn">保存当前自选</button>
            <button id="load-watchlist-btn" type="button" data-i18n="watchlist_refresh_btn">刷新自选列表</button>
          </div>

          <div id="watchlist-list" class="watchlist-list">
            <div class="watchlist-empty" data-i18n="watchlist_empty">暂无已保存自选组</div>
          </div>
        </div>
      </details>

      <div class="actions-row">
        <button id="refresh-btn" type="button" data-i18n="refresh_btn">刷新数据</button>
        <button id="financial-refresh-btn" type="button" data-i18n="force_refresh_btn">强制刷新财务缓存</button>
        <button id="export-btn" type="button" data-i18n="export_btn">导出Excel</button>
        <button id="screenshot-btn" type="button" data-i18n="screenshot_btn">截屏下载</button>
        <a id="history-page-link" class="action-link" href="{{ url_for('history_page') }}" target="_blank" rel="noopener">投资笔记/历史分析</a>
      </div>

      <div id="compare-error-panel" class="compare-error-panel" hidden>
        <div class="compare-error-head">
          <div id="compare-error-title" class="compare-error-title">抓取失败明细</div>
          <button id="compare-error-dismiss-btn" class="compare-error-dismiss-btn" type="button" data-i18n="compare_error_dismiss_btn">关闭提醒</button>
        </div>
        <ul id="compare-error-list" class="compare-error-list"></ul>
      </div>

      <input id="symbols" name="symbols" type="hidden" value="{{ default_symbols }}" />
      <input id="default-ui-language" name="default-ui-language" type="hidden" value="{{ default_ui_language }}" />
    </section>

    <section>
      <h2 id="section-realtime-title" data-i18n="section_realtime">1) 实时行情</h2>
      <div class="table-wrap"><table id="realtime-table"></table></div>
    </section>

    <section>
      <h2 id="section-financial-title" data-i18n="section_financial">2) 最新财务数据</h2>
      <div class="table-wrap"><table id="financial-table"></table></div>
    </section>

    <section>
      <h2 id="section-prediction-title" data-i18n="section_prediction">3) 预测</h2>
      <div class="table-wrap"><table id="prediction-table"></table></div>
      <details class="insight-panel">
        <summary id="beat-miss-summary" data-i18n="beat_miss_summary">财报 beat/miss、历史 EPS surprise（点击展开）</summary>
        <div id="beat-miss-output" class="md-preview" data-i18n="beat_miss_empty">请先抓取数据，再查看历史超预期表现。</div>
      </details>
      <details class="insight-panel">
        <summary id="eps-trend-summary" data-i18n="eps_trend_summary">一致预期变化 EPS Trend（7/30/60/90天）（点击展开）</summary>
        <div id="eps-trend-output" class="md-preview" data-i18n="eps_trend_empty">请先抓取数据，再查看一致预期变化趋势。</div>
      </details>
    </section>

    <section>
      <h2 id="section-valuation-title" data-i18n="section_valuation">4) 估值</h2>
      <div class="table-wrap"><table id="forecast-table"></table></div>
    </section>

    <section>
      <h2 id="section-earnings-title" data-i18n="section_earnings">5) 财务分析</h2>
      <div class="ai-actions">
        <button id="earnings-btn" type="button" disabled data-i18n="generate_earnings_btn">生成财务分析</button>
        <button id="copy-earnings-btn" type="button" data-i18n="copy_btn">复制输出</button>
      </div>
      <div id="earnings-output" class="md-preview" data-i18n="earnings_initial_empty">请先抓取数据，再生成财务分析。</div>
      <div class="followup-panel">
        <div class="followup-row">
          <input id="earnings-followup-input" type="text" data-i18n-placeholder="earnings_followup_placeholder" placeholder="继续追问财务分析，例如：AI业务收入占比是多少？" disabled />
          <button id="earnings-followup-btn" type="button" disabled data-i18n="followup_send_btn">发送追问</button>
        </div>
        <div id="earnings-followup-thread" class="followup-thread">
          <div class="followup-empty" data-i18n="earnings_followup_empty">财务分析生成后可继续追问。</div>
        </div>
      </div>
    </section>

    <section>
      <h2 id="section-ai-title" data-i18n="section_ai">6) 投资建议</h2>
      <div class="ai-actions">
        <button id="ai-btn" type="button" disabled data-i18n="generate_ai_btn">生成 AI 综合建议</button>
        <button id="copy-ai-btn" type="button" data-i18n="copy_btn">复制输出</button>
      </div>
      <div id="ai-output" class="md-preview" data-i18n="ai_initial_empty">请先抓取数据，再生成建议。</div>
      <div class="followup-panel">
        <div class="followup-row">
          <input id="ai-followup-input" type="text" data-i18n-placeholder="ai_followup_placeholder" placeholder="继续追问投资建议，例如：竞争对手 AMD 最新动态？" disabled />
          <button id="ai-followup-btn" type="button" disabled data-i18n="followup_send_btn">发送追问</button>
        </div>
        <div id="ai-followup-thread" class="followup-thread">
          <div class="followup-empty" data-i18n="ai_followup_empty">AI 建议生成后可继续追问。</div>
        </div>
      </div>
    </section>

    <section>
      <h2 id="section-target-title" data-i18n="section_target_price">7) 目标价</h2>
      <div class="ai-actions">
        <button id="target-price-btn" type="button" disabled data-i18n="generate_target_btn">生成目标价分析</button>
        <button id="copy-target-price-btn" type="button" data-i18n="copy_btn">复制输出</button>
      </div>
      <div id="target-price-output" class="md-preview" data-i18n="target_initial_empty">请先抓取数据，再生成目标价分析。</div>
    </section>

    <section class="toolbar api-toolbar">
      <details id="api-config-panel">
        <summary>
          <span id="api-config-title" data-i18n="api_config_title">API 配置与测试</span>
          <span class="summary-hint" data-i18n="api_config_hint">点击展开/收起</span>
        </summary>
        <div class="config-grid">
          <div class="field-row">
            <label id="finnhub-api-key-label" for="finnhub-api-key" data-i18n="finnhub_key_label">Finnhub API Key（可选）</label>
            <input id="finnhub-api-key" type="password" data-i18n-placeholder="finnhub_key_placeholder" placeholder="可选：用于第1部分实时行情优先数据源" autocomplete="off" />
          </div>

          <div class="field-row">
            <label id="ai-provider-label" for="ai-provider" data-i18n="ai_provider_label">AI Provider</label>
            <select id="ai-provider">
              <option value="openai" data-i18n="ai_provider_openai">OpenAI 兼容</option>
              <option value="gemini">Gemini</option>
              <option value="claude">Claude</option>
            </select>
          </div>
          <div class="field-row">
            <label id="ai-model-label" for="ai-model" data-i18n="ai_model_label">AI 模型</label>
            <input id="ai-model" type="text" data-i18n-placeholder="ai_model_placeholder" placeholder="例如 gpt-4.1-mini" autocomplete="off" />
          </div>
          <div class="field-row">
            <label id="ai-base-url-label" for="ai-base-url" data-i18n="ai_base_url_label">OpenAI 兼容 Base URL</label>
            <input id="ai-base-url" type="text" data-i18n-placeholder="ai_base_url_placeholder" placeholder="默认 https://api.openai.com/v1" autocomplete="off" />
          </div>
          <div class="field-row">
            <label id="ai-api-key-label" for="ai-api-key" data-i18n="ai_api_key_label">AI API Key</label>
            <input id="ai-api-key" type="password" data-i18n-placeholder="ai_api_key_placeholder" placeholder="粘贴 AI Key" autocomplete="off" />
          </div>
          <div class="field-row">
            <label id="exa-api-key-label" for="exa-api-key" data-i18n="exa_api_key_label">Exa API Key（可选）</label>
            <input id="exa-api-key" type="password" data-i18n-placeholder="search_key_placeholder" placeholder="可选：用于外部搜索增强" autocomplete="off" />
          </div>
          <div class="field-row">
            <label id="tavily-api-key-label" for="tavily-api-key" data-i18n="tavily_api_key_label">Tavily API Key（可选）</label>
            <input id="tavily-api-key" type="password" data-i18n-placeholder="search_key_placeholder" placeholder="可选：用于外部搜索增强" autocomplete="off" />
          </div>
          <div class="config-actions">
            <button id="test-finnhub-btn" type="button" data-i18n="test_finnhub_btn">测试 Finnhub 配置</button>
            <button id="test-ai-btn" type="button" data-i18n="test_ai_btn">测试 AI 配置</button>
            <button id="test-exa-btn" type="button" data-i18n="test_exa_btn">测试 Exa 配置</button>
            <button id="test-tavily-btn" type="button" data-i18n="test_tavily_btn">测试 Tavily 配置</button>
          </div>
        </div>
      </details>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.6/dist/purify.min.js"></script>
  <script src="{{ url_for('static', filename='app.js') }}?v=20260211_1"></script>
</body>
</html>
